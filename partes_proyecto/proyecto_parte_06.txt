PARTE: 06
PROYECTO: SIGEA_DSI
FECHA: 2025-11-11 09:49:28
CARPETAS EXCLUIDAS: bootstrap, jquery, fontawesome, etc.
================================================================================


============================================================
ARCHIVO: app\modules\main\templates\main\index.html
============================================================

<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Principal</title>
    <link rel="stylesheet" href="{{ url_for('main.static', filename='main.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">Bienvenido al Dashboard</h1>
        <div class="list-group">
            <a href="{{ url_for('auth.login') }}" class="list-group-item list-group-item-action">üîê M√≥dulo Auth</a>
            
        </div>
    </div>
</body>
</html>



============================================================
ARCHIVO: app\modules\reportes\routes.py
============================================================

# reportes/routes.py - VERSI√ìN COMPLETAMENTE CORREGIDA
from flask import render_template, request, jsonify, flash, redirect, url_for, send_file
from flask_login import login_required, current_user
import os
import pdfkit
from datetime import datetime
import tempfile
import platform
from . import reportes_bp
from app.services.report_generator import ReportGenerator
from app.models import Reporte, Estudiante
from app.extensions import db

def get_pdf_config():
    """Configuraci√≥n portable para pdfkit en diferentes sistemas"""
    try:
        # Detectar sistema operativo
        if platform.system() == "Windows":
            # Rutas comunes en Windows
            possible_paths = [
                r'C:\Program Files\wkhtmltopdf\bin\wkhtmltopdf.exe',
                r'C:\Program Files (x86)\wkhtmltopdf\bin\wkhtmltopdf.exe',
                'wkhtmltopdf.exe'  # Si est√° en el PATH
            ]
        else:
            # Linux/Mac
            possible_paths = [
                '/usr/bin/wkhtmltopdf',
                '/usr/local/bin/wkhtmltopdf',
                'wkhtmltopdf'
            ]
        
        # Buscar wkhtmltopdf
        for path in possible_paths:
            if os.path.exists(path):
                return pdfkit.configuration(wkhtmltopdf=path)
        
        # Si no se encuentra, usar None (asume que est√° en PATH)
        return pdfkit.configuration()
        
    except Exception as e:
        print(f"Advertencia en configuraci√≥n PDF: {e}")
        return pdfkit.configuration()
    
    
@reportes_bp.route('/')
@login_required
def index():
    """Panel principal de reportes"""
    return render_template('reportes/index.html')


@reportes_bp.route('/individual')
@login_required
def individual():
    """Reporte individual de estudiantes"""
    estudiantes = Estudiante.query.filter_by(activo=True).all()
    return render_template('reportes/individual.html', estudiantes=estudiantes)

@reportes_bp.route('/generar-individual', methods=['POST'])
@login_required
def generar_individual():
    """Generar reporte individual - VERSI√ìN CORREGIDA"""
    try:
        estudiante_id = request.form.get('estudiante_id')
        semestre = request.form.get('semestre')
        formato = request.form.get('formato', 'html')
        
        generator = ReportGenerator()
        resultado = generator.generar_reporte_riesgo_individual(estudiante_id, semestre)
        
        # Guardar en base de datos
        reporte = Reporte(
            tipo_reporte='INDIVIDUAL_RIESGO',
            titulo=f'Reporte de Riesgo - {resultado["estudiante"].nombres} {resultado["estudiante"].apellidos}',
            descripcion=f'Reporte individual de riesgo acad√©mico para el semestre {semestre}',
            parametros={
                'estudiante_id': estudiante_id,
                'semestre': semestre,
                'formato': formato
            },
            contenido=resultado['html'],
            usuario_id=current_user.id
        )
        db.session.add(reporte)
        db.session.commit()
        
        if formato == 'pdf':
            try:
                config = get_pdf_config()
                
                # Opciones optimizadas para PDF
                options = {
                    'page-size': 'A4',
                    'margin-top': '.5in',
                    'margin-right': '1.0in',
                    'margin-bottom': '1.0in',
                    'margin-left': '1.0in',
                    'encoding': "UTF-8",
                    'no-outline': None,
                    'enable-local-file-access': None,
                    'dpi': 300,
                    'print-media-type': None
                }
                
                # CSS espec√≠fico para PDF
                css_pdf = """
                <style>
                    body { 
                        font-family: 'Arial', sans-serif; 
                        font-size: 12px; 
                        line-height: 1.4;
                        color: #333;
                        margin: 0;
                        padding: 0;
                    }
                    .container { max-width: 100%; padding: 0; }
                    .header { 
                        text-align: center; 
                        border-bottom: 2px solid #2c3e50; 
                        padding-bottom: 10px;
                        margin-bottom: 20px;
                    }
                    .header h1 { 
                        color: #2c3e50; 
                        margin: 0; 
                        font-size: 18px;
                    }
                    .header .subtitle {
                        color: #7f8c8d;
                        font-size: 14px;
                        margin: 5px 0;
                    }
                    .info-section { margin: 15px 0; }
                    .info-section h3 { 
                        color: #34495e; 
                        border-bottom: 1px solid #bdc3c7;
                        padding-bottom: 5px;
                        font-size: 14px;
                    }
                    .table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 10px 0;
                        font-size: 11px;
                    }
                    .table th {
                        background-color: #34495e;
                        color: white;
                        padding: 8px;
                        text-align: left;
                        border: 1px solid #2c3e50;
                    }
                    .table td {
                        padding: 6px 8px;
                        border: 1px solid #ddd;
                    }
                    .table tr:nth-child(even) {
                        background-color: #f8f9fa;
                    }
                    .alerta-roja { color: #dc3545; font-weight: bold; }
                    .alerta-amarilla { color: #ffc107; font-weight: bold; }
                    .sin-riesgo { color: #28a745; font-weight: bold; }
                    .footer {
                        margin-top: 30px;
                        text-align: center;
                        font-size: 10px;
                        color: #7f8c8d;
                        border-top: 1px solid #bdc3c7;
                        padding-top: 10px;
                    }
                    .no-print { display: none; }
                    .page-break { page-break-after: always; }
                    
                    .firmas-container {
    display: flex;
    justify-content: space-between;
    margin-top: 50px;
    page-break-inside: avoid;
}

.firma {
    text-align: center;
    width: 45%;
}

.firma-linea {
    border-top: 1px solid #000;
    margin: 40px 0 10px 0;
    width: 100%;
}

.firma-texto {
    font-size: 11px;
    margin-top: 5px;
}
                </style>
                """
                
                html_para_pdf = f"""
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>{reporte.titulo}</title>
                    {css_pdf}
                </head>
                <body>
                    <div class="container">
                        {resultado['html']}
                    </div>
                </body>
                </html>
                """
                
                pdf = pdfkit.from_string(html_para_pdf, False, configuration=config, options=options)
                
                # Guardar PDF
                filename = f"reporte_individual_{estudiante_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
                filepath = os.path.join(generator.reports_dir, filename)
                
                with open(filepath, 'wb') as f:
                    f.write(pdf)
                
                reporte.archivo_path = filepath
                db.session.commit()
                
                return send_file(filepath, as_attachment=True, download_name=filename)
                
            except Exception as pdf_error:
                flash(f'Error generando PDF: {str(pdf_error)}. Verifique que wkhtmltopdf est√© instalado.', 'danger')
                # Fallback: ofrecer HTML
                return render_template('reportes/vista_previa.html', 
                                     contenido=resultado['html'],
                                     titulo=reporte.titulo,
                                     reporte_id=reporte.id,
                                     fecha_generacion=datetime.now().strftime('%d/%m/%Y a las %H:%M'))
        
        # Retornar HTML para vista previa
        return render_template('reportes/vista_previa.html', 
                             contenido=resultado['html'],
                             titulo=reporte.titulo,
                             reporte_id=reporte.id,
                             fecha_generacion=datetime.now().strftime('%d/%m/%Y a las %H:%M'))
    
    except Exception as e:
        db.session.rollback()
        flash(f'Error generando reporte: {str(e)}', 'danger')
        return redirect(url_for('reportes.individual'))
    
    
@reportes_bp.route('/general')
@login_required
def general():
    """Reporte general de riesgo"""
    return render_template('reportes/general.html')

# Aplicar las mismas correcciones a generar_general()
@reportes_bp.route('/generar-general', methods=['POST'])
@login_required
def generar_general():
    """Generar reporte general - VERSI√ìN CORREGIDA"""
    try:
        semestre = request.form.get('semestre')
        categoria_filtro = request.form.get('categoria_filtro', 'TODOS')
        formato = request.form.get('formato', 'html')
        
        generator = ReportGenerator()
        resultado = generator.generar_reporte_riesgo_general(semestre, categoria_filtro)
        
        # Guardar en base de datos
        reporte = Reporte(
            tipo_reporte='GENERAL_RIESGO',
            titulo=f'Reporte General de Riesgo - {semestre}',
            descripcion=f'Reporte general de riesgo acad√©mico. Filtro: {categoria_filtro}',
            parametros={
                'semestre': semestre,
                'categoria_filtro': categoria_filtro,
                'formato': formato
            },
            contenido=resultado['html'],
            usuario_id=current_user.id
        )
        db.session.add(reporte)
        db.session.commit()
        
        if formato == 'pdf':
            try:
                config = get_pdf_config()
                
                options = {
                    'page-size': 'A4',
                    'margin-top': '.5in',
                    'margin-right': '1.0in',
                    'margin-bottom': '1.0in',
                    'margin-left': '1.0in',
                    'encoding': "UTF-8",
                    'no-outline': None,
                    'enable-local-file-access': None,
                    'dpi': 300,
                    'print-media-type': None
                }
                
                pdf = pdfkit.from_string(resultado['html'], False, configuration=config, options=options)
                
                filename = f"reporte_general_{semestre}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
                filepath = os.path.join(generator.reports_dir, filename)
                
                with open(filepath, 'wb') as f:
                    f.write(pdf)
                
                reporte.archivo_path = filepath
                db.session.commit()
                
                return send_file(filepath, as_attachment=True, download_name=filename)
                
            except Exception as pdf_error:
                flash(f'Error generando PDF: {str(pdf_error)}', 'danger')
                return render_template('reportes/vista_previa.html', 
                                     contenido=resultado['html'],
                                     titulo=reporte.titulo,
                                     reporte_id=reporte.id)
        
        return render_template('reportes/vista_previa.html', 
                             contenido=resultado['html'],
                             titulo=reporte.titulo,
                             reporte_id=reporte.id)
    
    except Exception as e:
        db.session.rollback()
        flash(f'Error generando reporte: {str(e)}', 'danger')
        return redirect(url_for('reportes.general'))
    
    
    
@reportes_bp.route('/historial')
@login_required
def historial():
    """Historial de reportes generados"""
    page = request.args.get('page', 1, type=int)
    per_page = 10
    
    reportes = Reporte.query.filter_by(usuario_id=current_user.id).order_by(
        Reporte.fecha_generacion.desc()
    ).paginate(page=page, per_page=per_page, error_out=False)
    
    return render_template('reportes/historial.html', reportes=reportes)


@reportes_bp.route('/descargar/<int:reporte_id>')
@login_required
def descargar(reporte_id):
    """Descargar reporte generado anteriormente"""
    reporte = Reporte.query.get_or_404(reporte_id)
    
    if reporte.usuario_id != current_user.id and current_user.rol != 'administrador':
        flash('No tiene permisos para acceder a este reporte', 'danger')
        return redirect(url_for('reportes.historial'))
    
    if reporte.archivo_path and os.path.exists(reporte.archivo_path):
        filename = f"reporte_{reporte.tipo_reporte}_{reporte.id}.pdf"
        return send_file(reporte.archivo_path, as_attachment=True, download_name=filename)
    else:
        flash('El archivo del reporte no est√° disponible', 'warning')
        return redirect(url_for('reportes.historial'))


============================================================
ARCHIVO: app\modules\reportes\__init__.py
============================================================

from flask import Blueprint

reportes_bp = Blueprint('reportes', __name__, url_prefix='/reportes')

from . import routes


============================================================
ARCHIVO: app\modules\seguimiento\routes.py
============================================================

# app/modules/seguimiento/routes.py - VERSI√ìN DEFINITIVAMENTE CORREGIDA
from flask import render_template, request, jsonify, flash, redirect, url_for
from flask_login import login_required, current_user
from . import seguimiento_bp
from app.services.riesgo_calculator_v2 import CalculatorRiesgoIntrasemestral
from app.models import Estudiante, SeguimientoRiesgo
from app.extensions import db
from app.modules.admin.routes import cargar_configuracion  # IMPORTAR CONFIGURACI√ìN

@seguimiento_bp.route('/')
@login_required
def index():
    """Panel de control del m√≥dulo de seguimiento"""
    return render_template('seguimiento/index.html')

@seguimiento_bp.route('/calcular-riesgo', methods=['POST'])
@login_required
def calcular_riesgo():
    """Ejecutar c√°lculo de riesgo para todos los estudiantes"""
    try:
        # CORRECCI√ìN: Usar semestre por defecto 2025-1 en lugar de 2025-2
        semestre = request.form.get('semestre', '2025-1')
        
        # CORRECCI√ìN: Cargar configuraci√≥n del sistema
        config = cargar_configuracion()
        
        # CORRECCI√ìN: Pasar configuraci√≥n al calculador
        calculador = CalculatorRiesgoIntrasemestral(config)
        
        estudiantes = Estudiante.query.filter_by(activo=True).all()
        estudiantes_procesados = 0
        
        for estudiante in estudiantes:
            try:
                # CORRECCI√ìN: Pasar db correctamente
                resultado = calculador.calcular_riesgo_estudiante(estudiante.id, semestre, db)
                
                # Guardar en base de datos
                seguimiento = SeguimientoRiesgo.query.filter_by(
                    estudiante_id=estudiante.id, 
                    semestre=semestre
                ).first()
                
                if seguimiento:
                    seguimiento.categoria_riesgo = resultado['categoria']
                    seguimiento.puntaje_riesgo = resultado['puntaje_riesgo']
                    seguimiento.factores_riesgo = resultado['factores']
                else:
                    seguimiento = SeguimientoRiesgo(
                        estudiante_id=estudiante.id,
                        semestre=semestre,
                        categoria_riesgo=resultado['categoria'],
                        puntaje_riesgo=resultado['puntaje_riesgo'],
                        factores_riesgo=resultado['factores']
                    )
                    db.session.add(seguimiento)
                
                estudiantes_procesados += 1
                
            except Exception as e:
                print(f"Error procesando estudiante {estudiante.id}: {e}")
                continue
        
        db.session.commit()
        
        flash(f'‚úÖ C√°lculo de riesgo completado! {estudiantes_procesados} estudiantes evaluados.', 'success')
        return redirect(url_for('seguimiento.resultados'))
        
    except Exception as e:
        db.session.rollback()
        flash(f'‚ùå Error ejecutando c√°lculo: {str(e)}', 'danger')
        return redirect(url_for('seguimiento.index'))

@seguimiento_bp.route('/resultados')
@login_required
def resultados():
    """Mostrar resultados del c√°lculo de riesgo"""
    # Estad√≠sticas de riesgo
    stats_query = db.session.query(
        SeguimientoRiesgo.categoria_riesgo,
        db.func.count(SeguimientoRiesgo.id)
    ).group_by(SeguimientoRiesgo.categoria_riesgo).all()
    
    estadisticas = {categoria: cantidad for categoria, cantidad in stats_query}
    
    # √öltimos c√°lculos
    ultimos_seguimientos = SeguimientoRiesgo.query.order_by(
        SeguimientoRiesgo.fecha_evaluacion.desc()
    ).limit(10).all()
    
    return render_template('seguimiento/resultados.html',
                         estadisticas=estadisticas,
                         ultimos_seguimientos=ultimos_seguimientos)

@seguimiento_bp.route('/api/calcular-estudiante/<int:estudiante_id>')
@login_required
def calcular_estudiante(estudiante_id):
    """API para calcular riesgo de un estudiante espec√≠fico"""
    try:
        # CORRECCI√ìN: Semestre por defecto 2025-1
        semestre = request.args.get('semestre', '2025-1')
        estudiante = Estudiante.query.get_or_404(estudiante_id)
        
        # CORRECCI√ìN: Cargar configuraci√≥n
        config = cargar_configuracion()
        calculador = CalculatorRiesgoIntrasemestral(config)
        
        resultado = calculador.calcular_riesgo_estudiante(estudiante_id, semestre, db)
        
        return jsonify({
            'estudiante': {
                'id': estudiante.id,
                'codigo': estudiante.codigo_estudiante,
                'nombre': f"{estudiante.nombres} {estudiante.apellidos}"
            },
            'resultado': resultado
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


============================================================
ARCHIVO: app\modules\seguimiento\__init__.py
============================================================

# app/modules/seguimiento/__init__.py
from flask import Blueprint

seguimiento_bp = Blueprint('seguimiento', __name__, url_prefix='/seguimiento')

from . import routes


============================================================
ARCHIVO: app\services\report_generator.py
============================================================

import os
import json
from datetime import datetime
from flask import render_template
from app.models import Estudiante, SeguimientoRiesgo, Curso, Inscripcion, Nota, Asistencia
from app.extensions import db

class ReportGenerator:
    def __init__(self):
        self.reports_dir = os.path.join(os.path.dirname(__file__), '../static/reports')
        os.makedirs(self.reports_dir, exist_ok=True)
    
    def generar_reporte_riesgo_individual(self, estudiante_id, semestre=None):
        """Genera reporte individual de riesgo para un estudiante"""
        estudiante = Estudiante.query.get_or_404(estudiante_id)
        
        if not semestre:
            from app.modules.admin.routes import obtener_semestre_actual
            semestre = obtener_semestre_actual()
        
        # Obtener seguimiento de riesgo m√°s reciente
        seguimiento = SeguimientoRiesgo.query.filter_by(
            estudiante_id=estudiante_id,
            semestre=semestre
        ).order_by(SeguimientoRiesgo.fecha_evaluacion.desc()).first()
        
        # Obtener cursos del semestre
        cursos = Curso.query.join(Inscripcion).filter(
            Inscripcion.estudiante_id == estudiante_id,
            Curso.semestre == semestre
        ).all()
        
        # Obtener notas y asistencias
        datos_cursos = []
        for curso in cursos:
            # Promedio de notas del curso
            promedio_query = db.session.query(db.func.avg(Nota.nota)).join(
                Inscripcion
            ).filter(
                Inscripcion.estudiante_id == estudiante_id,
                Inscripcion.curso_id == curso.id
            ).scalar()
            
            # Asistencia del curso
            asistencia_query = db.session.query(
                db.func.count(Asistencia.id),
                db.func.sum(db.cast(Asistencia.presente, db.Integer))
            ).join(Inscripcion).filter(
                Inscripcion.estudiante_id == estudiante_id,
                Inscripcion.curso_id == curso.id
            ).first()
            
            total_clases = asistencia_query[0] or 0
            asistencias = asistencia_query[1] or 0
            porcentaje_asistencia = (asistencias / total_clases * 100) if total_clases > 0 else 0
            
            datos_cursos.append({
                'curso': curso,
                'promedio': round(promedio_query, 2) if promedio_query else 'Sin notas',
                'asistencia': round(porcentaje_asistencia, 1),
                'total_clases': total_clases
            })
        
        # Renderizar template HTML
        html_content = render_template(
            'reportes/individual_riesgo.html',
            estudiante=estudiante,
            seguimiento=seguimiento,
            cursos=datos_cursos,
            semestre=semestre,
            fecha_generacion=datetime.now().strftime('%d/%m/%Y %H:%M')
        )
        
        return {
            'html': html_content,
            'estudiante': estudiante,
            'seguimiento': seguimiento,
            'datos_cursos': datos_cursos
        }
    
    def generar_reporte_riesgo_general(self, semestre=None, categoria_filtro=None):
        """Genera reporte general de riesgo para todos los estudiantes"""
        if not semestre:
            from app.modules.admin.routes import obtener_semestre_actual
            semestre = obtener_semestre_actual()
        
        # Obtener estudiantes en riesgo
        query = db.session.query(Estudiante, SeguimientoRiesgo).join(
            SeguimientoRiesgo, Estudiante.id == SeguimientoRiesgo.estudiante_id
        ).filter(
            SeguimientoRiesgo.semestre == semestre,
            Estudiante.activo == True
        )
        
        if categoria_filtro and categoria_filtro != 'TODOS':
            query = query.filter(SeguimientoRiesgo.categoria_riesgo == categoria_filtro)
        
        estudiantes_riesgo = query.order_by(
            SeguimientoRiesgo.puntaje_riesgo.desc()
        ).all()
        
        # Estad√≠sticas
        total_estudiantes = Estudiante.query.filter_by(activo=True).count()
        total_riesgo = len(estudiantes_riesgo)
        
        # Conteo por categor√≠a
        categorias_count = db.session.query(
            SeguimientoRiesgo.categoria_riesgo,
            db.func.count(SeguimientoRiesgo.id)
        ).filter(
            SeguimientoRiesgo.semestre == semestre
        ).group_by(SeguimientoRiesgo.categoria_riesgo).all()
        
        estadisticas = {
            'total_estudiantes': total_estudiantes,
            'total_riesgo': total_riesgo,
            'porcentaje_riesgo': (total_riesgo / total_estudiantes * 100) if total_estudiantes > 0 else 0,
            'categorias': dict(categorias_count)
        }
        
        html_content = render_template(
            'reportes/general_riesgo.html',
            estudiantes_riesgo=estudiantes_riesgo,
            estadisticas=estadisticas,
            semestre=semestre,
            categoria_filtro=categoria_filtro,
            fecha_generacion=datetime.now().strftime('%d/%m/%Y %H:%M')
        )
        
        return {
            'html': html_content,
            'estadisticas': estadisticas,
            'estudiantes_riesgo': estudiantes_riesgo
        }

